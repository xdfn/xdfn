Ext.define("xdfn.project.Contract",{extend:"xdfn.project.ui.Contract",initComponent:function(){var a=this;a.conStore=Ext.create("xdfn.project.store.ContractJsonStore");a.prodStore=Ext.create("xdfn.project.store.ProductionJsonStore",{proxy:{type:"ajax",url:"./projectMgr.do?method=getConCqjbjList",reader:{type:"json",root:"data"}}});a.rowEditing=Ext.create("Ext.grid.plugin.RowEditing",{errorSummary:false});a.callParent(arguments);a.down('button[text="增加合同"]').on("click",a.OnAddContractBtnClick,a);a.down('button[text="修改合同"]').on("click",a.OnModifyContractBtnClick,a);a.down('button[text="删除合同"]').on("click",a.OnDeleteContractBtnClick,a);a.down('button[text="增加产品"]').on("click",a.OnAddProductionBtnClick,a);a.down('button[text="产品明细"]').on("click",a.OnDetailProductionBtnClick,a);a.down('button[text="删除产品"]').on("click",a.OnDeleteProductionBtnClick,a);a.down('button[text="查找"]').on("click",a.OnSearchBtnClick,a);a.down('button[text="重置"]').on("click",a.OnResetBtnClick,a);a.down('button[text="导出"]').on("click",a.OnExportContractBtnClick,a);a.down('button[text="导出产品"]').on("click",a.OnExportProductionBtnClick,a);a.down("gridpanel").on("select",a.OnContractGridSelect,a);a.down("gridpanel").on("itemdblclick",a.OnContractGridItemDbClick,a);a.rowEditing.on("edit",a.OnGridEdit,a);a.rowEditing.on("beforeedit",a.OnGridBeforeEdit,a);a.conStore.on("load",a.OnContractStoreLoad,a)},OnGridBeforeEdit:function(b,d,a){var c=this;xdfn.user.Rights.noRights("XMGL-HTGL-7",function(){c.rowEditing.cancelEdit()})},OnContractStoreLoad:function(b,a,e,c){var d=this;Ext.apply(d.prodStore.getProxy(),{extraParams:{}});d.prodStore.loadRawData([])},OnAddContractBtnClick:function(a,d,b){var c=this;xdfn.user.Rights.hasRights("XMGL-HTGL-2",function(){Ext.create("xdfn.project.ContractWindow",{url:"./projectMgr.do?method=addContract",grid:a.up("gridpanel")}).show()})},OnContractGridItemDbClick:function(b,a,h,d,i,f){var g=this;var c=Ext.create("xdfn.project.ContractWindow",{title:"查看合同",enableSubmit:false});c.down("form").getForm().load({url:"./projectMgr.do?method=findContractById",params:{ID:a.get("ID_VIEW")},method:"get",success:function(e,j){c.show()},failure:function(e,j){c.destroy();Ext.Msg.alert("提示","无法查看！")}})},OnModifyContractBtnClick:function(a,g,b){var d=this,c=a.up("gridpanel"),h=c.getSelectionModel(),f=h.getSelection();xdfn.user.Rights.hasRights("XMGL-HTGL-3",function(){if(f.length>0){var e=Ext.create("xdfn.project.ContractWindow",{title:"修改合同",url:"./projectMgr.do?method=modifyContract",grid:c,ID:f[0].get("ID_VIEW")});e.down("form").getForm().load({url:"./projectMgr.do?method=findContractById",params:{ID:f[0].get("ID_VIEW")},method:"get",success:function(i,j){e.show()},failure:function(i,j){e.destroy();Ext.Msg.alert("提示","无法修改！")}})}else{Ext.Msg.alert("提示","请选择要修改的合同！")}})},OnDeleteContractBtnClick:function(b,h,c){var f=this,d=b.up("gridpanel"),a=d.getStore(),i=d.getSelectionModel(),g=i.getSelection();xdfn.user.Rights.hasRights("XMGL-HTGL-4",function(){if(g.length>0){Ext.MessageBox.confirm("提示","确定删除该合同吗？",function(e){if(e=="yes"){Ext.Ajax.request({url:"./projectMgr.do?method=deleteContract",method:"get",params:{ID:g[0].get("ID_VIEW")},success:function(j,m){var k=a.indexOf(g[0]);a.remove(g);var l=a.getCount();if(l>0){i.select((k==l)?--k:k)}else{a.fireEvent("load",a)}},failure:function(j,k){Ext.Msg.alert("提示","删除失败！")}})}})}else{Ext.Msg.alert("提示","请选择要删除的合同！")}})},OnGridEdit:function(c,f,b){var d=this;if(!f.record.dirty){return}var a="./projectMgr.do?method=modifyConCqjbj";if(Ext.isEmpty(f.record.get("ID_VIEW"))){f.record.set("ID_VIEW",d.ID);a="./projectMgr.do?method=addConCqjbj"}f.record.commit();Ext.Ajax.request({url:a,method:"post",params:{ID:f.record.get("ID_VIEW"),V_JX:f.record.get("V_JX_VIEW"),N_DJRL:f.record.get("N_DJRL_VIEW"),N_NUM:f.record.get("N_NUM_VIEW"),N_PRICE:f.record.get("N_PRICE_VIEW"),V_MEMO:f.record.get("V_MEMO_VIEW")},success:function(g,h){var e=Ext.JSON.decode(g.responseText);f.record.set(e.data);f.record.commit()},failure:function(e,g){Ext.Msg.alert("提示","提交失败！")}})},OnAddProductionBtnClick:function(a,g,b){var d=this,c=d.down("gridpanel"),h=c.getSelectionModel(),f=h.getSelection();xdfn.user.Rights.hasRights("XMGL-HTGL-6",function(){if(f.length>0){d.rowEditing.cancelEdit();d.prodStore.insert(0,{});d.rowEditing.startEdit(0,0)}else{Ext.Msg.alert("提示","请先选择相应的合同！")}})},OnDeleteProductionBtnClick:function(b,h,c){var f=this,d=b.up("gridpanel"),a=d.getStore(),i=d.getSelectionModel(),g=i.getSelection();xdfn.user.Rights.hasRights("XMGL-HTGL-8",function(){if(g.length>0){if(Ext.isEmpty(g[0].get("ID_VIEW"))){f.rowEditing.cancelEdit();var e=a.indexOf(g[0]);a.remove(g);var j=a.getCount();if(j>0){i.select((e==j)?--e:e)}return}Ext.MessageBox.confirm("提示","确定删除该产品吗？",function(k){if(k=="yes"){Ext.Ajax.request({url:"./projectMgr.do?method=deleteConCqjbj",method:"get",params:{ID:g[0].get("ID_VIEW")},success:function(l,o){f.rowEditing.cancelEdit();var m=a.indexOf(g[0]);a.remove(g);var n=a.getCount();if(n>0){i.select((m==n)?--m:m)}},failure:function(l,m){Ext.Msg.alert("提示","删除失败！")}})}})}else{Ext.Msg.alert("提示","请选择要删除的产品！")}})},OnDetailProductionBtnClick:function(a,g,b){var d=this,c=a.up("gridpanel"),h=c.getSelectionModel(),f=h.getSelection();if(f.length>0){Ext.create("xdfn.project.ProductDetailWindow",{ID:f[0].get("ID_VIEW")}).show()}else{Ext.Msg.alert("提示","请先选择相应的产品！")}},OnContractGridSelect:function(e,a,b,c){var d=this;d.ID=a.get("ID_VIEW");Ext.apply(d.prodStore.getProxy(),{extraParams:{ID:d.ID}});d.prodStore.load()},OnSearchBtnClick:function(a,f,b){var d=this;var c=a.up("form").getForm();if(!c.isValid()){return}Ext.apply(d.conStore.getProxy(),{extraParams:c.getValues()});d.conStore.load()},OnResetBtnClick:function(a,c,b){a.up("form").getForm().reset()},OnExportContractBtnClick:function(a,d,b){var c=this;xdfn.user.Rights.hasRights("XMGL-HTGL-5",function(){c.conStore.load({limit:c.conStore.getTotalCount(),scope:this,callback:function(g,f,h){var e=Ext.ux.exporter.Exporter.exportGrid(a.up("gridpanel"),"excel",{title:"合同信息表"});document.location="data:application/vnd.ms-excel;base64,"+Ext.ux.exporter.Base64.encode(e)}})})},OnExportProductionBtnClick:function(a,d,b){var c=this;xdfn.user.Rights.hasRights("XMGL-HTGL-5",function(){c.prodStore.load({limit:c.prodStore.getTotalCount(),scope:this,callback:function(g,f,h){var e=Ext.ux.exporter.Exporter.exportGrid(a.up("gridpanel"),"excel",{title:"合同产品信息表"});document.location="data:application/vnd.ms-excel;base64,"+Ext.ux.exporter.Base64.encode(e)}})})}});
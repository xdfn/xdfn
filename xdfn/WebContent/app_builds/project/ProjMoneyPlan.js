Ext.define("xdfn.project.ProjMoneyPlan",{extend:"xdfn.project.ui.ProjMoneyPlan",grid:null,detailTab:null,detailStore:null,initComponent:function(){var a=this;a.planStore=Ext.create("xdfn.project.store.ProjMoneyPlanJsonStore");a.rowEditing=Ext.create("Ext.grid.plugin.RowEditing",{errorSummary:false});a.callParent(arguments);a.down('button[text="增加计划"]').on("click",a.OnAddMoneyPlanBtnClick,a);a.down('button[text="删除计划"]').on("click",a.OnDeleteMoneyPlanBtnClick,a);a.down('button[text="导出"]').on("click",a.OnExportMoneyPlanBtnClick,a);a.rowEditing.on("edit",a.OnGridEdit,a);a.rowEditing.on("beforeedit",a.OnGridBeforeEdit,a);a.down("pagingtoolbar").on("change",a.OnPagingToolBarChange,a)},OnGridBeforeEdit:function(b,c,a){xdfn.user.Rights.noRights("XMGL-HKGL-6",function(){b.cancelEdit()})},OnPagingToolBarChange:function(a,c,b){var d=this,f=d.grid.getSelectionModel(),e=f.getSelection();if(e.length>0){d.detailStore.clearFilter();d.detailStore.filter("V_NAME_VIEW",e[0].get("V_NAME_VIEW"));d.detailStore.group("V_NAME_VIEW")}else{d.detailStore.clearFilter();d.detailStore.group("V_NAME_VIEW")}d.planStore.group("V_NAME_VIEW")},OnGridEdit:function(b,f){var c=this;if(!f.record.dirty){return}var a="./projectMgr.do?method=modifyHkjh";if(Ext.isEmpty(f.record.get("ID_VIEW"))){var d=c.grid.getSelectionModel().getSelection();f.record.set("ID_VIEW",d[0].get("ID_VIEW"));a="./projectMgr.do?method=addHkjh"}f.record.commit();Ext.Ajax.request({url:a,method:"post",params:{ID:f.record.get("ID_VIEW"),N_FHTS:f.record.get("N_FHTS_VIEW"),N_YSZK:f.record.get("N_YSZK_VIEW"),D_HKRQ:Ext.util.Format.date(f.record.get("D_HKRQ_VIEW"),"Y-m-d"),V_HKZRR:f.record.get("V_HKZRR_VIEW"),V_REM:f.record.get("V_REM_VIEW")},success:function(g,h){var e=Ext.JSON.decode(g.responseText);f.record.set(e.data);f.record.commit();c.planStore.group("V_NAME_VIEW")},failure:function(e,g){Ext.Msg.alert("提示","提交失败！")}})},OnAddMoneyPlanBtnClick:function(a,f,b){var c=this,d=c.grid.getSelectionModel().getSelection();xdfn.user.Rights.hasRights("XMGL-HKGL-5",function(){if(d.length>0){c.rowEditing.cancelEdit();c.planStore.clearGrouping();c.planStore.insert(0,{});c.planStore.getAt(0).set("V_NAME_VIEW",d[0].get("V_NAME_VIEW"));c.rowEditing.startEdit(0,0)}else{Ext.Msg.alert("提示","请先选择相应的指标！")}})},OnDeleteMoneyPlanBtnClick:function(b,h,c){var f=this,d=b.up("gridpanel"),a=d.getStore(),i=d.getSelectionModel(),g=i.getSelection();xdfn.user.Rights.hasRights("XMGL-HKGL-7",function(){if(g.length>0){if(Ext.isEmpty(g[0].get("ID_VIEW"))){f.rowEditing.cancelEdit();var e=a.indexOf(g[0]);a.remove(g);var j=a.getCount();if(j>0){i.select((e==j)?--e:e)}return}Ext.MessageBox.confirm("提示","确定删除该回款计划吗？",function(k){if(k=="yes"){Ext.Ajax.request({url:"./projectMgr.do?method=deleteHkjh",method:"get",params:{ID:g[0].get("ID_VIEW")},success:function(l,o){f.rowEditing.cancelEdit();var m=a.indexOf(g[0]);a.remove(g);var n=a.getCount();if(n>0){i.select((m==n)?--m:m)}},failure:function(l,m){Ext.Msg.alert("提示","删除失败！")}})}})}else{Ext.Msg.alert("提示","请选择要删除的回款计划！")}})},OnPlanGridSelect:function(e,a,b,c){var d=this;d.up("tabpanel").setActiveTab(d.detailTab);d.detailStore.clearFilter();d.detailStore.filter([{property:"V_PLAN_ID_VIEW",value:a.get("ID_VIEW")},{property:"V_NAME_VIEW",value:a.get("V_NAME_VIEW")}]);d.detailStore.group("V_NAME_VIEW")},OnExportMoneyPlanBtnClick:function(a,d,b){var c=this;xdfn.user.Rights.hasRights("XMGL-HKGL-8",function(){c.planStore.load({limit:c.planStore.getTotalCount(),scope:this,callback:function(g,f,h){var e=Ext.ux.exporter.Exporter.exportGrid(a.up("gridpanel"),"excel",{title:"项目回款计划"});document.location="data:application/vnd.ms-excel;base64,"+Ext.ux.exporter.Base64.encode(e)}})})}});
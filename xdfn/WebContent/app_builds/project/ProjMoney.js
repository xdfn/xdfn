Ext.define("xdfn.project.ProjMoney",{extend:"xdfn.project.ui.ProjMoney",initComponent:function(){var a=this;a.conStore=Ext.create("xdfn.project.store.ContractJsonStore");a.inStore=Ext.create("xdfn.project.store.ProjMoneyInJsonStore");a.callParent(arguments);a.tabPanel=a.down("tabpanel");a.indexGrid=a.down('gridpanel[title="回款指标"]');a.planTab=a.tabPanel.add(Ext.create("xdfn.project.ProjMoneyPlan",{grid:a.indexGrid}));a.detailTab=a.tabPanel.add(Ext.create("xdfn.project.ProjMoneyDetail",{grid:a.planTab.down("gridpanel")}));Ext.apply(a.planTab,{detailTab:a.detailTab,detailStore:a.detailTab.detailStore});a.tabPanel.setActiveTab(a.planTab);a.subStore=new Ext.util.MixedCollection();a.subStore.add("ProjMoneyInJsonStore",a.inStore);a.subStore.add("ProjMoneyPlanJsonStore",a.planTab.planStore);a.subStore.add("ProjMoneyDetailJsonStore",a.detailTab.detailStore);a.down('button[text="增加款项"]').on("click",a.OnAddIndexBtnClick,a);a.down('button[text="删除款项"]').on("click",a.OnDeleteIndexBtnClick,a);a.down('button[text="查找"]').on("click",a.OnSearchBtnClick,a);a.down('button[text="重置"]').on("click",a.OnResetBtnClick,a);a.down("gridpanel").on("select",a.OnContractGridSelect,a);a.indexGrid.on("select",a.OnMoneyInGridSelect,a);a.conStore.on("load",a.OnContractStoreLoad,a);a.inStore.on("load",a.OnMoneyInStoreLoad,a);a.rowEditing.on("edit",a.OnGridEdit,a);a.rowEditing.on("beforeedit",a.OnGridBeforeEdit,a)},OnGridBeforeEdit:function(b,c,a){xdfn.user.Rights.noRights("XMGL-HKGL-3",function(){b.cancelEdit()})},OnGridEdit:function(a,c){var b=this;if(!c.record.dirty){return}c.record.commit();Ext.Ajax.request({url:"./projectMgr.do?method=modifyHkzb",method:"post",params:{ID:c.record.get("ID_VIEW"),V_NAME:c.record.get("V_NAME_VIEW"),V_PERCENT:c.record.get("V_PERCENT_VIEW"),N_SUM:c.record.get("N_SUM_VIEW")},success:function(e,f){var d=Ext.JSON.decode(e.responseText);c.record.set(d.data);c.record.commit()},failure:function(d,e){Ext.Msg.alert("提示","提交失败！")}})},OnAddIndexBtnClick:function(a,g,b){var d=this,c=d.down("gridpanel"),h=c.getSelectionModel(),f=h.getSelection();xdfn.user.Rights.hasRights("XMGL-HKGL-2",function(){if(f.length>0){Ext.create("xdfn.project.ProjMoneyInWindow",{url:"./projectMgr.do?method=addHkzb",grid:a.up("gridpanel"),ID:f[0].get("ID_VIEW")}).show()}else{Ext.Msg.alert("提示","请先选择相应的合同！")}})},OnDeleteIndexBtnClick:function(b,h,c){var f=this,d=b.up("gridpanel"),a=d.getStore(),i=d.getSelectionModel(),g=i.getSelection();xdfn.user.Rights.hasRights("XMGL-HKGL-4",function(){if(g.length>0){Ext.MessageBox.confirm("提示","确定删除该回款指标吗？",function(e){if(e=="yes"){Ext.Ajax.request({url:"./projectMgr.do?method=deleteHkzb",method:"get",params:{ID:g[0].get("ID_VIEW")},success:function(j,m){f.rowEditing.cancelEdit();var k=a.indexOf(g[0]);a.remove(g);var l=a.getCount();if(l>0){i.select((k==l)?--k:k)}else{a.fireEvent("load",a)}},failure:function(j,k){Ext.Msg.alert("提示","删除失败！")}})}})}else{Ext.Msg.alert("提示","请选择要删除的回款指标！")}})},OnContractStoreLoad:function(b,a,e,c){var d=this;d.subStore.each(function(f){Ext.apply(f.getProxy(),{extraParams:{}});f.loadRawData([])})},OnMoneyInStoreLoad:function(b,a,e,c){var d=this;d.subStore.eachKey(function(f,g){if(f=="ProjMoneyInJsonStore"){return}g.clearFilter();g.loadPage(1)})},OnSearchBtnClick:function(a,f,b){var d=this;var c=a.up("form").getForm();if(!c.isValid()){return}Ext.apply(d.conStore.getProxy(),{extraParams:c.getValues()});d.conStore.loadPage(1)},OnResetBtnClick:function(a,c,b){a.up("form").getForm().reset()},OnContractGridSelect:function(e,a,b,c){var d=this;d.subStore.eachKey(function(f,g){Ext.apply(g.getProxy(),{extraParams:{ID:a.get("ID_VIEW")}});g.loadPage(1);if(!g.isGrouped()){g.group("V_NAME_VIEW")}})},OnMoneyInGridSelect:function(e,a,b,c){var d=this;d.subStore.eachKey(function(f,g){if(f=="ProjMoneyInJsonStore"){return}g.clearFilter();g.filter("V_NAME_VIEW",a.get("V_NAME_VIEW"));g.group("V_NAME_VIEW")})}});
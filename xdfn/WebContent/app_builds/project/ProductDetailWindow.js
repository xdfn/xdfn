Ext.define("xdfn.project.ProductDetailWindow",{extend:"xdfn.project.ui.ProductDetailWindow",ID:null,url:null,initComponent:function(){var a=this;a.detailStore=Ext.create("xdfn.project.store.ProductDetailJsonStore",{proxy:{type:"ajax",url:"./projectMgr.do?method=getProDetailList&ID="+a.ID,reader:{type:"json",root:"data"}}});a.rowEditing=Ext.create("Ext.grid.plugin.RowEditing",{errorSummary:false});a.callParent(arguments);a.down('button[text="增加"]').on("click",a.OnAddProductDetailBtnClick,a);a.down('button[text="删除"]').on("click",a.OnDeleteProductDetailBtnClick,a);a.down('button[text="导出"]').on("click",a.OnExportProductDetailBtnClick,a);a.rowEditing.on("edit",a.OnGridEdit,a);a.rowEditing.on("beforeedit",a.OnGridBeforeEdit,a)},OnGridBeforeEdit:function(c,a){var b=this;xdfn.user.Rights.noRights("XMGL-HTGL-10",function(){b.rowEditing.cancelEdit()})},OnGridEdit:function(b,d){var c=this;if(!d.record.dirty){return}var a="./projectMgr.do?method=modifyProDetail";if(Ext.isEmpty(d.record.get("ID_VIEW"))){d.record.set("ID_VIEW",c.ID);a="./projectMgr.do?method=addProDetail"}d.record.commit();Ext.Ajax.request({url:a,method:"post",params:{ID:d.record.get("ID_VIEW"),V_PARTS_TYPE:d.record.get("V_PARTS_TYPE_VIEW"),V_PARTS_NAME:d.record.get("V_PARTS_NAME_VIEW"),V_PARTS_MODEL:d.record.get("V_PARTS_MODEL_VIEW"),V_PARTS_UNIT:d.record.get("V_PARTS_UNIT_VIEW"),V_PARTS_NUM:d.record.get("V_PARTS_NUM_VIEW"),V_PARTS_PRICE:d.record.get("V_PARTS_PRICE_VIEW"),V_VENDER1:d.record.get("V_VENDER1_VIEW"),V_VENDER2:d.record.get("V_VENDER2_VIEW"),V_VENDER3:d.record.get("V_VENDER3_VIEW"),V_VENDER4:d.record.get("V_VENDER4_VIEW"),V_VENDER5:d.record.get("V_VENDER5_VIEW")},success:function(f,g){var e=Ext.JSON.decode(f.responseText);d.record.set(e.data);d.record.commit()},failure:function(e,f){Ext.Msg.alert("提示","提交失败！")}})},OnAddProductDetailBtnClick:function(a,d,b){var c=this;xdfn.user.Rights.hasRights("XMGL-HTGL-9",function(){c.rowEditing.cancelEdit();c.detailStore.insert(0,{});c.rowEditing.startEdit(0,0)})},OnDeleteProductDetailBtnClick:function(b,h,c){var f=this,d=b.up("gridpanel"),a=d.getStore(),i=d.getSelectionModel(),g=i.getSelection();xdfn.user.Rights.hasRights("XMGL-HTGL-11",function(){if(g.length>0){if(Ext.isEmpty(g[0].get("ID_VIEW"))){f.rowEditing.cancelEdit();var e=a.indexOf(g[0]);a.remove(g);var j=a.getCount();if(j>0){i.select((e==j)?--e:e)}return}Ext.MessageBox.confirm("提示","确定删除该产品明细吗？",function(k){if(k=="yes"){Ext.Ajax.request({url:"./projectMgr.do?method=deleteProDetail",method:"get",params:{ID:g[0].get("ID_VIEW")},success:function(l,o){f.rowEditing.cancelEdit();var m=a.indexOf(g[0]);a.remove(g);var n=a.getCount();if(n>0){i.select((m==n)?--m:m)}},failure:function(l,m){Ext.Msg.alert("提示","删除失败！")}})}})}else{Ext.Msg.alert("提示","请选择要删除的产品明细！")}})},OnExportProductDetailBtnClick:function(a,d,b){var c=this;xdfn.user.Rights.hasRights("XMGL-HTGL-12",function(){c.detailStore.load({limit:c.detailStore.getTotalCount(),scope:this,callback:function(g,f,h){var e=Ext.ux.exporter.Exporter.exportGrid(a.up("gridpanel"),"excel",{title:"合同产品明细表"});document.location="data:application/vnd.ms-excel;base64,"+Ext.ux.exporter.Base64.encode(e)}})})}});
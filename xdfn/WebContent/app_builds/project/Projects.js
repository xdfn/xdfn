Ext.define("xdfn.project.Projects",{extend:"xdfn.project.ui.Projects",initComponent:function(){var a=this;if(a.ID){a.projStore=Ext.create("xdfn.project.store.ProjectsJsonStore",{proxy:{type:"ajax",url:"./projectMgr.do?method=getProjectList",reader:{type:"json",root:"data"},extraParams:{ID:a.ID}}})}else{a.projStore=Ext.create("xdfn.project.store.ProjectsJsonStore")}a.callParent(arguments);a.tabPanel=a.down("tabpanel");a.grid=a.down("gridpanel");a.applyTab=a.tabPanel.add(Ext.create("xdfn.project.ProjApply",{grid:a.grid}));a.followTab=a.tabPanel.add(Ext.create("xdfn.project.ProjFollow",{grid:a.grid}));a.filesTab=a.tabPanel.add(Ext.create("xdfn.project.ProjFiles",{grid:a.grid}));a.tabPanel.setActiveTab(a.applyTab);a.subStore=new Ext.util.MixedCollection();a.subStore.add("ProjApplyJsonStore",a.applyTab.applyStore);a.subStore.add("ProjFollowJsonStore",a.followTab.followStore);a.subStore.add("ProjFilesJsonStore",a.filesTab.filesStore);a.down('button[text="预报项目"]').on("click",a.OnAddPreProjectBtnClick,a);a.down('button[text="修改项目"]').on("click",a.OnModifyProjectBtnClick,a);a.down('button[text="删除项目"]').on("click",a.OnDeleteProjectBtnClick,a);a.down('button[text="导出"]').on("click",a.OnExportProjectBtnClick,a);a.down('button[text="查找"]').on("click",a.OnSearchBtnClick,a);a.down('button[text="重置"]').on("click",a.OnResetBtnClick,a);a.down("gridpanel").on("select",a.OnProjectGridSelect,a);a.down("gridpanel").on("itemdblclick",a.OnProjectGridItemDbClick,a);a.projStore.on("load",a.OnProjectStoreLoad,a)},OnProjectStoreLoad:function(b,a,e,c){var d=this;d.subStore.each(function(f){Ext.apply(f.getProxy(),{extraParams:{}});f.loadRawData([])})},OnAddPreProjectBtnClick:function(a,d,b){var c=this;xdfn.user.Rights.hasRights("XMGL-XMZL-2",function(){Ext.create("xdfn.project.ProjectWindow",{url:"./projectMgr.do?method=addProject",grid:a.up("gridpanel")}).show()})},OnProjectGridItemDbClick:function(b,a,h,d,i,f){var g=this;var c=Ext.create("xdfn.project.ProjectWindow",{title:"查看项目",enableSubmit:false});c.down("form").getForm().load({url:"./projectMgr.do?method=findProById",params:{ID:a.get("ID_VIEW")},method:"get",success:function(e,j){c.show()},failure:function(e,j){c.destroy();Ext.Msg.alert("提示","查看项目！")}})},OnModifyProjectBtnClick:function(a,g,b){var d=this,c=a.up("gridpanel"),h=c.getSelectionModel(),f=h.getSelection();xdfn.user.Rights.hasRights("XMGL-XMZL-3",function(){if(f.length>0){var e=Ext.create("xdfn.project.ProjectWindow",{title:"修改项目",url:"./projectMgr.do?method=modifyProject",grid:c,ID:f[0].get("ID_VIEW")});e.down("form").getForm().load({url:"./projectMgr.do?method=findProById",params:{ID:f[0].get("ID_VIEW")},method:"get",success:function(i,j){e.show()},failure:function(i,j){e.destroy();Ext.Msg.alert("提示","无法修改！")}})}else{Ext.Msg.alert("提示","请选择要修改的项目！")}})},OnDeleteProjectBtnClick:function(b,h,c){var f=this,d=b.up("gridpanel"),a=d.getStore(),i=d.getSelectionModel(),g=i.getSelection();xdfn.user.Rights.hasRights("XMGL-XMZL-4",function(){if(g.length>0){Ext.MessageBox.confirm("提示","确定删除该项目吗？",function(e){if(e=="yes"){Ext.Ajax.request({url:"./projectMgr.do?method=deleteProject",method:"get",params:{ID:g[0].get("ID_VIEW")},success:function(j,m){var k=a.indexOf(g[0]);a.remove(g);var l=a.getCount();if(l>0){i.select((k==l)?--k:k)}else{a.fireEvent("load",a)}},failure:function(j,k){Ext.Msg.alert("提示","删除失败！")}})}})}else{Ext.Msg.alert("提示","请选择要删除的项目！")}})},OnExportProjectBtnClick:function(a,d,b){var c=this;xdfn.user.Rights.hasRights("XMGL-XMZL-5",function(){c.projStore.load({limit:c.projStore.getTotalCount(),scope:this,callback:function(g,f,h){var e=Ext.ux.exporter.Exporter.exportGrid(a.up("gridpanel"),"excel",{title:"项目信息表"});document.location="data:application/vnd.ms-excel;base64,"+Ext.ux.exporter.Base64.encode(e)}})})},OnSearchBtnClick:function(a,f,b){var d=this;var c=a.up("form").getForm();if(!c.isValid()){return}Ext.apply(d.projStore.getProxy(),{extraParams:c.getValues()});d.projStore.load()},OnResetBtnClick:function(a,c,b){a.up("form").getForm().reset()},OnProjectGridSelect:function(e,a,b,c){var d=this;switch(a.get("V_PRO_PHASE_VIEW")){case"项目投标":case"项目中标":case"项目失标":case"合同管理":case"合同执行":case"合同废除":case"过240":case"质保期":case"已过质保期":if(!d.bookTab){d.bookTab=d.tabPanel.add(Ext.create("xdfn.project.ProjBook",{grid:d.grid}));d.subStore.add("ProjBookJsonStore",d.bookTab.bookStore)}if(!d.prodTab){d.prodTab=d.tabPanel.add(Ext.create("xdfn.project.ProjProduct",{grid:d.grid}));d.subStore.add("ProjProductJsonStore",d.prodTab.prodStore)}if(!d.openTab){d.openTab=d.tabPanel.add(Ext.create("xdfn.project.ProjOpen",{grid:d.grid}));d.subStore.add("ProjOpenJsonStore",d.openTab.openStore)}if(!d.standTab){d.standTab=d.tabPanel.add(Ext.create("xdfn.project.ProjStanding",{grid:d.grid}));d.subStore.add("ProjStandingJsonStore",d.standTab.standStore)}break;case"项目预报":case"项目跟进":case"重点项目":case"项目不投标":if(d.prodTab){d.prodTab.close();d.prodTab=null;d.subStore.removeAtKey("ProjProductJsonStore")}if(d.openTab){d.openTab.close();d.openTab=null;d.subStore.removeAtKey("ProjOpenJsonStore")}if(d.bookTab){d.bookTab.close();d.bookTab=null;d.subStore.removeAtKey("ProjBookJsonStore")}if(d.standTab){d.standTab.close();d.standTab=null;d.subStore.removeAtKey("ProjStandingJsonStore")}break}d.subStore.each(function(f){Ext.apply(f.getProxy(),{extraParams:{ID:a.get("ID_VIEW")}});f.load()})}});
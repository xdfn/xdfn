Ext.define("xdfn.user.EmployeeManager",{extend:"xdfn.user.ui.EmployeeManager",initComponent:function(){var a=this;a.empStore=Ext.create("xdfn.user.store.EmployeeJsonStore");a.familyStore=Ext.create("xdfn.user.store.FamilyJsonStore");a.deptStore=Ext.create("xdfn.com.store.DeptDutyTreeStore",{proxy:{type:"ajax",url:"./deptManage.do?method=getList&node=root",reader:{type:"json"}}});a.callParent(arguments);a.down("treepanel").on("load",a.OnTreePanelLoad,a);a.down('button[text="增加员工"]').on("click",a.OnAddEmployeeBtnClick,a);a.down('button[text="修改员工"]').on("click",a.OnModifyEmployeeBtnClick,a);a.down('button[text="删除员工"]').on("click",a.OnDeleteEmployeeBtnClick,a);a.down('button[text="增加家属"]').on("click",a.OnAddFamilyBtnClick,a);a.down('button[text="修改家属"]').on("click",a.OnModifyFamilyBtnClick,a);a.down('button[text="删除家属"]').on("click",a.OnDeleteFamilyBtnClick,a);a.down('button[text="查找"]').on("click",a.OnSearchBtnClick,a);a.down('button[text="重置"]').on("click",a.OnResetBtnClick,a);a.down('button[text="增加"]').on("click",a.OnAddDeptDutyBtnClick,a);a.down('button[text="修改"]').on("click",a.OnModifyDeptDutyBtnClick,a);a.down('button[text="删除"]').on("click",a.OnDeleteDeptDutyBtnClick,a);a.down('button[text="重置密码"]').on("click",a.OnResetPasswordBtnClick,a);a.down('button[text="导出"]').on("click",a.OnExportEmployeeBtnClick,a);a.down('button[text="导出家属"]').on("click",a.OnExportFamilyBtnClick,a);a.down("gridpanel").on("select",a.OnEmployeeGridSelect,a);a.down("treepanel").on("select",a.OnDeptDutyTreeSelect,a);a.empStore.on("load",a.OnEmployeeStoreLoad,a)},OnEmployeeStoreLoad:function(b,a,e,c){var d=this;Ext.apply(d.familyStore.getProxy(),{extraParams:{}});d.familyStore.loadRawData([])},OnAddEmployeeBtnClick:function(a,d,b){var c=this;xdfn.user.Rights.hasRights("XTGL-YGGL-5",function(){Ext.create("xdfn.user.EmployeeWindow",{url:"userManage.do?method=add",grid:a.up("gridpanel")}).show()})},OnModifyEmployeeBtnClick:function(a,g,b){var d=this,c=a.up("gridpanel"),h=c.getSelectionModel(),f=h.getSelection();xdfn.user.Rights.hasRights("XTGL-YGGL-6",function(){if(f.length>0){var e=Ext.create("xdfn.user.EmployeeWindow",{title:"修改员工",url:"userManage.do?method=modify",grid:c,ID:f[0].get("ID_VIEW")});e.down("form").getForm().load({url:"userManage.do?method=findById",params:{ID:f[0].get("ID_VIEW")},method:"get",success:function(i,j){e.show()},failure:function(i,j){e.destroy();Ext.Msg.alert("提示","无法修改！")}})}else{Ext.Msg.alert("提示","请选择要修改的员工！")}})},OnDeleteEmployeeBtnClick:function(b,h,c){var f=this,d=b.up("gridpanel"),a=d.getStore(),i=d.getSelectionModel(),g=i.getSelection();xdfn.user.Rights.hasRights("XTGL-YGGL-7",function(){if(g.length>0){Ext.MessageBox.confirm("提示","确定删除该员工吗？",function(e){if(e=="yes"){Ext.Ajax.request({url:"userManage.do?method=delete",method:"get",params:{ID:g[0].get("ID_VIEW")},success:function(j,m){var k=a.indexOf(g[0]);a.remove(g);var l=a.getCount();if(l>0){i.select((k==l)?--k:k)}else{a.fireEvent("load",a)}},failure:function(j,k){Ext.Msg.alert("提示","删除失败！")}})}})}else{Ext.Msg.alert("提示","请选择要删除的员工！")}})},OnResetPasswordBtnClick:function(a,g,b){var d=this,c=a.up("gridpanel"),h=c.getSelectionModel(),f=h.getSelection();xdfn.user.Rights.hasRights("XTGL-YGGL-8",function(){if(f.length>0){Ext.MessageBox.confirm("提示","确定重置该帐号密码吗？",function(e){if(e=="yes"){Ext.Ajax.request({url:"userManage.do?method=resetPwd",method:"get",params:{ID:f[0].get("ID_VIEW")},success:function(i,j){Ext.Msg.alert("提示","重置密码成功！")},failure:function(i,j){Ext.Msg.alert("提示","重置密码失败！")}})}})}else{Ext.Msg.alert("提示","请选择要重置密码的员工！")}})},OnAddFamilyBtnClick:function(a,g,b){var d=this,c=d.down("gridpanel"),h=c.getSelectionModel(),f=h.getSelection();xdfn.user.Rights.hasRights("XTGL-YGGL-10",function(){if(f.length>0){Ext.create("xdfn.user.FamilyWindow",{url:"userManage.do?method=addFamily",grid:a.up("gridpanel"),ID:f[0].get("V_USER_FK_VIEW")}).show()}else{Ext.Msg.alert("提示","请先选择相应的员工！")}})},OnModifyFamilyBtnClick:function(a,g,b){var d=this,c=a.up("gridpanel"),h=c.getSelectionModel(),f=h.getSelection();xdfn.user.Rights.hasRights("XTGL-YGGL-11",function(){if(f.length>0){var e=Ext.create("xdfn.user.FamilyWindow",{title:"修改家属",url:"userManage.do?method=modifyFamily",grid:c,ID:f[0].get("ID_VIEW")});e.down("form").getForm().load({url:"userManage.do?method=findFamilyById",params:{ID:f[0].get("ID_VIEW")},method:"get",success:function(i,j){e.show()},failure:function(i,j){e.destroy();Ext.Msg.alert("提示","无法修改！")}})}else{Ext.Msg.alert("提示","请选择要修改的家属！")}})},OnDeleteFamilyBtnClick:function(b,h,c){var f=this,d=b.up("gridpanel"),a=d.getStore(),i=d.getSelectionModel(),g=i.getSelection();xdfn.user.Rights.hasRights("XTGL-YGGL-12",function(){if(g.length>0){Ext.MessageBox.confirm("提示","确定删除该家属吗？",function(e){if(e=="yes"){Ext.Ajax.request({url:"userManage.do?method=deleteFamily",method:"get",params:{ID:g[0].get("ID_VIEW")},success:function(j,m){var k=a.indexOf(g[0]);a.remove(g);var l=a.getCount();if(l>0){i.select((k==l)?--k:k)}},failure:function(j,k){Ext.Msg.alert("提示","删除失败！")}})}})}else{Ext.Msg.alert("提示","请选择要删除的家属！")}})},OnAddDeptDutyBtnClick:function(c,g,d){var f=this,a=f.down("treepanel"),h=a.getSelectionModel(),b=h.getSelection();xdfn.user.Rights.hasRights("XTGL-YGGL-2",function(){if(b.length>0){if(b[0].get("N_NODE_TYPE_VIEW")==2){Ext.Msg.alert("提示","不能在职务节点上增加！");return}Ext.create("xdfn.user.DeptDutyWindow",{url:"deptManage.do?method=add",selectNode:b[0],deptree:a}).show()}else{Ext.Msg.alert("提示","请先选择相应的节点！")}})},OnModifyDeptDutyBtnClick:function(c,g,d){var f=this,a=f.down("treepanel"),h=a.getSelectionModel(),b=h.getSelection();xdfn.user.Rights.hasRights("XTGL-YGGL-3",function(){if(b.length>0){var i=Ext.create("xdfn.user.DeptDutyWindow",{title:"修改部门或职务",url:"deptManage.do?method=modify",selectNode:b[0],deptree:a});var e="部门";switch(b[0].get("N_NODE_TYPE_VIEW")){case 1:e="部门";break;case 2:e="职务";break;case 3:e="岗位";break}var j=Ext.ModelManager.create({V_COMBOX_NAME_VIEW:e,V_COMBOX_VALUE_VIEW:b[0].get("N_NODE_TYPE_VIEW")},"Combox");i.down('combobox[name="N_NODE_TYPE"]').setValue(j);i.down('textfield[name="V_NODE_NAME"]').setValue(b[0].get("V_NODE_NAME_VIEW"));i.show()}else{Ext.Msg.alert("提示","请选择要修改的部门或职务！")}})},OnDeleteDeptDutyBtnClick:function(c,g,d){var f=this,a=f.down("treepanel"),h=a.getSelectionModel(),b=h.getSelection();xdfn.user.Rights.hasRights("XTGL-YGGL-4",function(){if(b.length>0){Ext.MessageBox.confirm("提示","确定删除该部门或职务吗？",function(e){if(e=="yes"){Ext.Ajax.request({url:"deptManage.do?method=delete",method:"get",params:{ID:b[0].get("ID_VIEW")},success:function(i,j){a.getStore().load()},failure:function(i,j){Ext.Msg.alert("提示","删除失败！")}})}})}else{Ext.Msg.alert("提示","请选择要删除的部门或职务！")}})},OnSearchBtnClick:function(a,f,b){var d=this;var c=a.up("form").getForm();if(!c.isValid()){return}Ext.apply(d.empStore.getProxy(),{extraParams:c.getValues()});d.empStore.loadPage(1)},OnResetBtnClick:function(a,c,b){a.up("form").getForm().reset()},OnTreePanelLoad:function(b,a,e,c){var d=this;d.down("treepanel").expandAll()},OnEmployeeGridSelect:function(e,a,b,c){var d=this;Ext.apply(d.familyStore.getProxy(),{extraParams:{V_USER_FK:a.get("V_USER_FK_VIEW")}});d.familyStore.loadPage(1)},OnDeptDutyTreeSelect:function(e,a,b,c){var d=this;if(a.get("N_NODE_TYPE_VIEW")==2){Ext.apply(d.empStore.getProxy(),{extraParams:{V_PST_ID:a.get("ID_VIEW")}})}else{Ext.apply(d.empStore.getProxy(),{extraParams:{V_DEPT_ID:a.get("ID_VIEW")}})}d.empStore.loadPage(1)},OnExportEmployeeBtnClick:function(a,d,b){var c=this;xdfn.user.Rights.hasRights("XTGL-YGGL-9",function(){c.empStore.load({limit:c.empStore.getTotalCount(),scope:this,callback:function(g,f,h){var e=Ext.ux.exporter.Exporter.exportGrid(a.up("gridpanel"),"excel",{title:"员工信息表"});document.location="data:application/vnd.ms-excel;base64,"+Ext.ux.exporter.Base64.encode(e)}})})},OnExportFamilyBtnClick:function(a,d,b){var c=this;xdfn.user.Rights.hasRights("XTGL-YGGL-13",function(){c.familyStore.load({limit:c.familyStore.getTotalCount(),scope:this,callback:function(g,f,h){var e=Ext.ux.exporter.Exporter.exportGrid(a.up("gridpanel"),"excel",{title:"员工家属信息表"});document.location="data:application/vnd.ms-excel;base64,"+Ext.ux.exporter.Base64.encode(e)}})})}});